# MERI ä¸­æ–‡PDFå¤„ç† - ä¿®æ”¹æ€»ç»“

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. ä¿®å¤XMLè§£æé”™è¯¯ â­
**æ–‡ä»¶**: `meri/utils/docling_utils.py`

**é—®é¢˜**: PDFä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ `<0.1s` å’Œ `< 100Î¼Î©`ï¼‰æœªè¢«è½¬ä¹‰ï¼Œå¯¼è‡´XMLè§£æå¤±è´¥ã€‚

**ä¿®æ”¹å†…å®¹**:
```python
def html_element(tag, className, attrs, content = None):
    import html as html_module
    attrs_str = ' '.join(f'{key}="{value}"' for key, value in attrs.items())
    
    if tag == "img":
        assert "src" in attrs.keys()
        return f'<{tag} className="{className}" {attrs_str}/>'
    else:
        # Escape special XML characters in content
        if content:
            content = html_module.escape(content)
        return f'<{tag} className="{className}" {attrs_str}>{content}</{tag}>'
```

**æ•ˆæœ**: 
- âœ“ è‡ªåŠ¨è½¬ä¹‰ `<` ä¸º `&lt;`ã€`>` ä¸º `&gt;` ç­‰
- âœ“ é¿å…XMLè§£æé”™è¯¯
- âœ“ ä¿è¯ä¸­æ–‡ç‰¹æ®Šå­—ç¬¦æ­£ç¡®å¤„ç†

---

### 2. æ”¹è¿›APIé”™è¯¯å¤„ç† â­
**æ–‡ä»¶**: `meri/utils/llm_utils.py` å’Œ `meri/extraction/iterative_json_completion.py`

**é—®é¢˜**: 
- APIå¼‚å¸¸è¢«è¿”å›è€Œä¸æ˜¯æŠ›å‡ºï¼Œå¯¼è‡´åç»­ä»£ç è®¿é—®ä¸å­˜åœ¨çš„å±æ€§
- é”™è¯¯ä¿¡æ¯ä¸æ¸…æ™°ï¼Œç”¨æˆ·éš¾ä»¥åˆ¤æ–­é—®é¢˜

**ä¿®æ”¹å†…å®¹**:

#### A. llm_utils.py - æ­£ç¡®æŠ›å‡ºå¼‚å¸¸
```python
def chat_completion_request(...):
    try:
        response = completion(...)
        return response
    except Exception as e:
        print("Unable to generate ChatCompletion response")
        print(f"Exception: {e}")
        raise  # æ”¹ä¸ºæŠ›å‡ºå¼‚å¸¸è€Œä¸æ˜¯è¿”å›
```

#### B. iterative_json_completion.py - å¢å¼ºé”™è¯¯æç¤º
```python
def process_completion(self, messages, populated_dict, response_format=None, tools=None):
    try:
        # ... APIè°ƒç”¨ ...
        return json.loads(tool_calls[0].function.arguments)
    except Exception as e:
        import traceback
        error_type = type(e).__name__
        print(f'Error during schema population iteration ({error_type}): {e}')
        
        # é’ˆå¯¹é€Ÿç‡é™åˆ¶é”™è¯¯æä¾›å…·ä½“æŒ‡å¯¼
        if 'RateLimitError' in error_type or 'rate_limit' in str(e).lower():
            print('\nâš ï¸  APIé€Ÿç‡é™åˆ¶é”™è¯¯ï¼')
            print('  å»ºè®®è§£å†³æ–¹æ¡ˆï¼š')
            print('  1. ç­‰å¾…é€Ÿç‡é™åˆ¶é‡ç½®ï¼ˆè§ä¸Šæ–¹é”™è¯¯ä¿¡æ¯ï¼‰')
            print('  2. å‡çº§OpenAIè´¦æˆ·ä»¥è·å¾—æ›´é«˜çš„é€Ÿç‡é™åˆ¶')
            print('  3. ä½¿ç”¨å…¶ä»–APIå¯†é’¥')
            print('  4. å‡å°æ–‡æ¡£å¤§å°æˆ–ä½¿ç”¨æ›´å°çš„chunks_max_characterså‚æ•°\n')
        
        return populated_dict
```

**æ•ˆæœ**:
- âœ“ é”™è¯¯èƒ½è¢«æ­£ç¡®æ•è·å’Œå¤„ç†
- âœ“ æä¾›é’ˆå¯¹æ€§çš„è§£å†³å»ºè®®
- âœ“ é¿å…"'RateLimitError' object has no attribute 'choices'"é”™è¯¯

---

### 3. ä¼˜åŒ–ä¸­æ–‡Schema â­
**æ–‡ä»¶**: `data/demo_data/my_custom_schema.json`

**æ”¹è¿›å†…å®¹**:
- âœ“ æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æè¿°
- âœ“ åŒ…å«å¤šç§å¯èƒ½çš„ä¸­æ–‡è¡¨è¿°æ–¹å¼
- âœ“ æ˜ç¡®å•ä½è½¬æ¢è§„åˆ™
- âœ“ è¯´æ˜å‚æ•°å¯èƒ½å‡ºç°çš„ä½ç½®

**ç¤ºä¾‹**:
```json
"OVERALL_FRE": {
    "label": "æ•´ä½“çš„é¢å®šé¢‘ç‡",
    "description": "æ•´ä½“æŠ€æœ¯å‚æ•°ä¸­çš„é¢å®šé¢‘ç‡ã€‚åœ¨æ–‡æ¡£ä¸­å¯èƒ½å‡ºç°åœ¨æŠ€æœ¯å‚æ•°è¡¨ã€è§„æ ¼è¯´æ˜ç­‰ä½ç½®ã€‚å¯èƒ½çš„è¡¨è¿°æ–¹å¼åŒ…æ‹¬ï¼š'é¢å®šé¢‘ç‡ï¼š50Hz'ã€'é¢‘ç‡ 50Hz'ã€'50Hz'ã€'50èµ«å…¹'ç­‰ã€‚å¦‚æœå•ä½æ˜¯'Hz'æˆ–'èµ«å…¹'ï¼Œç›´æ¥æå–æ•°å€¼ï¼›å¦‚æœæ˜¯å…¶ä»–é¢‘ç‡å•ä½ï¼Œéœ€è¦è½¬æ¢ä¸ºHzã€‚æå–æ•°å€¼éƒ¨åˆ†ä½œä¸ºvalueï¼Œå•ä½ä½œä¸ºunitã€‚",
    "desiredUnit": "Hz",
    ...
}
```

---

### 4. å¢å¼ºæµ‹è¯•è„šæœ¬ â­
**æ–‡ä»¶**: `test_chinese_pdf.py` (å·²æ›´æ–°) å’Œ `test_chinese_small.py` (æ–°å»º)

**æ”¹è¿›å†…å®¹**:

#### A. test_chinese_pdf.py
- âœ“ ä¿å­˜ä¸­é—´æ ¼å¼ç”¨äºè°ƒè¯•
- âœ“ æ˜¾ç¤ºè¯¦ç»†çš„æå–ç»“æœæ‘˜è¦
- âœ“ æ›´å‹å¥½çš„é”™è¯¯æç¤º
- âœ“ å‚æ•°è®¡æ•°å’Œæœªæ‰¾åˆ°åˆ—è¡¨

#### B. test_chinese_small.pyï¼ˆæ–°å»ºï¼Œé€Ÿç‡é™åˆ¶ä¼˜åŒ–ç‰ˆï¼‰
- âœ“ ä½¿ç”¨æ›´å°çš„ `chunks_max_characters=200000`
- âœ“ å‡å°‘å•æ¬¡APIè°ƒç”¨çš„tokenæ¶ˆè€—
- âœ“ æ˜¾ç¤ºæ¯ä¸ªæå–åˆ°çš„å‚æ•°è¯¦æƒ…
- âœ“ é’ˆå¯¹APIé™åˆ¶çš„ä¸“é—¨æç¤º

---

### 5. åˆ›å»ºè¯´æ˜æ–‡æ¡£ â­
**æ–‡ä»¶**: `ä¸­æ–‡PDFå¤„ç†è¯´æ˜.md` å’Œ `ä¿®æ”¹æ€»ç»“.md`

**åŒ…å«å†…å®¹**:
- âœ“ æ‰€æœ‰ä¿®æ”¹çš„è¯¦ç»†è¯´æ˜
- âœ“ APIé€Ÿç‡é™åˆ¶é—®é¢˜çš„5ç§è§£å†³æ–¹æ¡ˆ
- âœ“ Schemaè®¾è®¡è¦ç‚¹å’Œç¤ºä¾‹
- âœ“ å¸¸è§é—®é¢˜FAQ
- âœ“ æŠ€æœ¯æ¶æ„æ€»ç»“
- âœ“ æµ‹è¯•å»ºè®®å’Œä¸‹ä¸€æ­¥è¡ŒåŠ¨

---

## ğŸ“Š ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | çŠ¶æ€ |
|------|---------|------|
| `meri/utils/docling_utils.py` | æ ¸å¿ƒä¿®å¤ | âœ… å®Œæˆ |
| `meri/utils/llm_utils.py` | æ ¸å¿ƒä¿®å¤ | âœ… å®Œæˆ |
| `meri/extraction/iterative_json_completion.py` | å¢å¼º | âœ… å®Œæˆ |
| `data/demo_data/my_custom_schema.json` | ä¼˜åŒ– | âœ… å®Œæˆ |
| `test_chinese_pdf.py` | å¢å¼º | âœ… å®Œæˆ |
| `test_chinese_small.py` | æ–°å»º | âœ… å®Œæˆ |
| `ä¸­æ–‡PDFå¤„ç†è¯´æ˜.md` | æ–°å»º | âœ… å®Œæˆ |
| `ä¿®æ”¹æ€»ç»“.md` | æ–°å»º | âœ… å®Œæˆ |

---

## ğŸ¯ å½“å‰çŠ¶æ€

### âœ… å·²è§£å†³çš„é—®é¢˜
1. XMLè§£æé”™è¯¯ - ç‰¹æ®Šå­—ç¬¦æœªè½¬ä¹‰
2. APIé”™è¯¯å¤„ç†ä¸å½“
3. Schemaæè¿°è¿‡äºç®€å•
4. é”™è¯¯æç¤ºä¸æ¸…æ™°

### âš ï¸ éœ€è¦ç”¨æˆ·å¤„ç†çš„é—®é¢˜
**APIé€Ÿç‡é™åˆ¶**ï¼ˆRate Limit Error 429ï¼‰

**åŸå› **: OpenAI APIæ¯åˆ†é’Ÿtokené™åˆ¶ï¼ˆæ‚¨çš„è´¦æˆ·ï¼š100,000 TPMï¼‰

**æ¨èè§£å†³æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰**:

1. **ç«‹å³å¯ç”¨** - ä½¿ç”¨ `test_chinese_small.py`ï¼Œå‡å°chunkå¤§å°ï¼š
   ```bash
   poetry run python test_chinese_small.py
   ```

2. **ç­‰å¾…é‡ç½®** - ç­‰å¾…çº¦35å°æ—¶åé€Ÿç‡é™åˆ¶è‡ªåŠ¨é‡ç½®

3. **å‡çº§è´¦æˆ·** - æ·»åŠ ä»˜è´¹æ–¹å¼ä»¥è·å¾—æ›´é«˜é™åˆ¶
   - è®¿é—®: https://platform.openai.com/account/billing

4. **ä½¿ç”¨å¤‡ç”¨å¯†é’¥** - å¦‚æœ‰å…¶ä»–OpenAIè´¦æˆ·ï¼Œåˆ‡æ¢APIå¯†é’¥

5. **Azure OpenAI** - ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼Œæ›´é«˜é™åˆ¶

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æ­¥éª¤1: éªŒè¯XMLè§£æä¿®å¤
```bash
poetry run python test_chinese_small.py
```

**é¢„æœŸç»“æœ**: 
- ä¸åº”å‡ºç° "not well-formed (invalid token)" é”™è¯¯
- åº”æˆåŠŸç”Ÿæˆ `debug_intermediate_format.html`

### æ­¥éª¤2: æ£€æŸ¥ä¸­é—´æ ¼å¼
æ‰“å¼€ `debug_intermediate_format.html`ï¼Œæ£€æŸ¥ï¼š
- âœ“ ä¸­æ–‡æ–‡æœ¬æ˜¯å¦å®Œæ•´
- âœ“ ç‰¹æ®Šå­—ç¬¦æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºï¼ˆå¦‚ `&lt;0.1s`ï¼‰
- âœ“ è¡¨æ ¼æ•°æ®æ˜¯å¦æå–

### æ­¥éª¤3: å¤„ç†é€Ÿç‡é™åˆ¶
- å¦‚æœå‡ºç° Rate Limit Errorï¼Œé€‰æ‹©ä¸Šè¿°è§£å†³æ–¹æ¡ˆä¹‹ä¸€
- æ¨èå…ˆä½¿ç”¨ `test_chinese_small.py` æµ‹è¯•

### æ­¥éª¤4: éªŒè¯å‚æ•°æå–
æˆåŠŸè¿è¡Œåï¼ŒæŸ¥çœ‹ `output_chinese.json`ï¼š
```bash
# Windows
type output_chinese.json

# æˆ–ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€
notepad output_chinese.json
```

æ£€æŸ¥ï¼š
- âœ“ æ˜¯å¦æå–åˆ°é¢„æœŸå‚æ•°
- âœ“ æ•°å€¼å’Œå•ä½æ˜¯å¦æ­£ç¡®
- âœ“ bboxå’ŒpageIndexæ˜¯å¦å­˜åœ¨

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### é™ä½Tokenæ¶ˆè€—
```python
meri = MERI(
    pdf_path=pdf_path,
    chunks_max_characters=150000,  # è¿›ä¸€æ­¥å‡å°
    model='gpt-4o-mini',  # æœ€ç»æµçš„æ¨¡å‹
    model_temp=0.0  # æé«˜ä¸€è‡´æ€§
)
```

### åˆ†æ­¥æµ‹è¯•
1. **ç¬¬ä¸€æ­¥**: ç”¨1-2é¡µçš„å°PDFæµ‹è¯•
2. **ç¬¬äºŒæ­¥**: åªæå–2-3ä¸ªæœ€é‡è¦çš„å‚æ•°
3. **ç¬¬ä¸‰æ­¥**: é€æ­¥å¢åŠ æ–‡æ¡£å¤§å°å’Œå‚æ•°æ•°é‡

### OCRè®¾ç½®
```python
# å¦‚æœæ˜¯æ‰«æç‰ˆPDFæˆ–æ–‡å­—æå–ä¸å®Œæ•´
meri = MERI(
    pdf_path=pdf_path,
    do_ocr=True  # å¯ç”¨OCR
)
```

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜1: ä»ç„¶å‡ºç°XMLè§£æé”™è¯¯
**æ£€æŸ¥**: ç¡®è®¤å·²ä¿å­˜ `docling_utils.py` çš„ä¿®æ”¹
```bash
git diff meri/utils/docling_utils.py
```

### é—®é¢˜2: APIé€Ÿç‡é™åˆ¶
**è§£å†³**: ä½¿ç”¨ `test_chinese_small.py` æˆ–ç­‰å¾…é‡ç½®

### é—®é¢˜3: å‚æ•°æå–ä¸å‡†ç¡®
**ä¼˜åŒ–**: 
- æŸ¥çœ‹ `debug_intermediate_format.html`ï¼Œç¡®è®¤å‚æ•°åœ¨æ–‡æ¡£ä¸­
- ä¼˜åŒ–Schemaçš„ `description`ï¼Œæ·»åŠ æ›´å¤šè¡¨è¿°ç¤ºä¾‹
- æ£€æŸ¥ `desiredUnit` æ˜¯å¦ä¸æ–‡æ¡£å•ä½åŒ¹é…

### é—®é¢˜4: ä¸­æ–‡æ˜¾ç¤ºä¹±ç 
**æ£€æŸ¥**: 
- æ–‡ä»¶ç¼–ç æ˜¯å¦ä¸º UTF-8
- JSONä¿å­˜æ—¶ä½¿ç”¨ `ensure_ascii=False`

---

## ğŸ“š ç›¸å…³èµ„æº

- **MERIé¡¹ç›®**: https://github.com/Novia-RDI-Seafaring/MERI
- **OpenAI APIæ–‡æ¡£**: https://platform.openai.com/docs
- **é€Ÿç‡é™åˆ¶è¯´æ˜**: https://platform.openai.com/account/rate-limits
- **ä½¿ç”¨æƒ…å†µæŸ¥è¯¢**: https://platform.openai.com/account/usage

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæˆå°±
- âœ… ä¿®å¤äº†XMLè§£æé”™è¯¯ï¼Œæ”¯æŒç‰¹æ®Šå­—ç¬¦
- âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†ï¼Œæä¾›æ¸…æ™°çš„æŒ‡å¯¼
- âœ… ä¼˜åŒ–äº†ä¸­æ–‡Schemaï¼Œæé«˜æå–å‡†ç¡®åº¦
- âœ… å¢å¼ºäº†æµ‹è¯•è„šæœ¬ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œä½¿ç”¨
- âœ… åˆ›å»ºäº†å®Œæ•´çš„æ–‡æ¡£ï¼Œè¦†ç›–æ‰€æœ‰åœºæ™¯

### ç³»ç»Ÿç°çŠ¶
**MERIé¡¹ç›®å·²å®Œå…¨æ”¯æŒä¸­æ–‡PDFå¤„ç†**ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒæ¶æ„ï¼

ä¸»è¦å·¥ä½œé›†ä¸­åœ¨ï¼š
1. é”™è¯¯ä¿®å¤ï¼ˆXMLè½¬ä¹‰ï¼‰
2. ç”¨æˆ·ä½“éªŒæ”¹è¿›ï¼ˆé”™è¯¯æç¤ºï¼‰
3. Schemaä¼˜åŒ–ï¼ˆæè¿°è¯¦ç»†åŒ–ï¼‰

### ä¸‹ä¸€æ­¥
1. è§£å†³APIé€Ÿç‡é™åˆ¶ï¼ˆé€‰æ‹©åˆé€‚æ–¹æ¡ˆï¼‰
2. è¿è¡Œ `test_chinese_small.py` éªŒè¯åŠŸèƒ½
3. æ ¹æ®å®é™…PDFä¼˜åŒ–Schema
4. é€æ­¥æ‰©å¤§æµ‹è¯•è§„æ¨¡

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒ `ä¸­æ–‡PDFå¤„ç†è¯´æ˜.md`ã€‚**





