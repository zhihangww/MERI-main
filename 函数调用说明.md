# 函数调用（Function Calling）说明

## 什么是函数调用？

"函数调用"（Function Calling / Tools）是 OpenAI API 的一个功能，用于让 AI 模型以**结构化、可靠的方式**输出数据。

## 在 MERI 项目中的作用

MERI 项目使用函数调用来确保模型输出的 JSON 数据**完全符合**您提供的 JSON Schema。

## 工作原理（简化版）

### 传统方式（直接输出 JSON）
```
用户：请输出 JSON 格式的数据
模型：{"name": "产品A", "price": 100}  ← 可能格式不对，可能缺少字段
```

### 函数调用方式
```
1. 定义"函数"：创建一个名为 populate_json_schema 的函数
   参数结构 = 您的 JSON Schema

2. 要求模型调用：模型必须"调用"这个函数，并传入符合 Schema 的数据

3. 提取数据：从函数调用的参数中提取 JSON
```

## 实际代码示例

在 MERI 项目中（`meri/extraction/iterative_json_completion.py`）：

```python
# 步骤 1：将您的 JSON Schema 定义为"函数"的参数
tools = [{
    "type": "function",
    "function": {
        "name": "populate_json_schema",           # 函数名
        "description": "填充 JSON schema",        # 函数描述
        "parameters": json_schema                 # 参数 = 您的 JSON Schema
    }
}]

# 步骤 2：要求模型调用这个函数
response = chat_completion_request(
    messages=messages,
    tools=tools,                                  # 传入函数定义
    tool_choice={"type": "function", "function": {"name": "populate_json_schema"}},  # 强制调用
    ...
)

# 步骤 3：从函数调用的参数中提取 JSON
tool_calls = response.choices[0].message.tool_calls
json_data = json.loads(tool_calls[0].function.arguments)  # 获取 JSON 数据
```

## 为什么使用函数调用？

| 特性 | 直接输出 JSON | 函数调用 |
|------|--------------|---------|
| **可靠性** | ⚠️ 可能格式错误 | ✅ 严格符合 Schema |
| **结构化** | ⚠️ 可能缺少字段 | ✅ 必须包含所有必需字段 |
| **错误处理** | ⚠️ 需要手动验证 | ✅ API 自动验证 |

## 如果模型不支持函数调用怎么办？

### 方案 1：使用 response_format（如果支持）
```python
response = completion(
    model=model,
    messages=messages,
    response_format={"type": "json_object"},  # 要求输出 JSON
    ...
)
```

### 方案 2：通过 Prompt 要求（可能不够可靠）
在 prompt 中明确要求：
```
"请严格按照以下 JSON Schema 输出 JSON 格式的数据：{schema}"
```

### 方案 3：修改代码（需要改动）
如果模型不支持函数调用，需要修改 `iterative_json_completion.py`：
- 改为直接解析模型输出的 JSON 文本
- 而不是从 `tool_calls` 中提取

## 对于 Hugging Face 模型

根据您的了解，Hugging Face 模型：
- ✅ 支持多模态
- ✅ 可以通过 prompt 输出 JSON 格式
- ❓ 可能不支持函数调用（tools 参数）

**建议**：
1. 先测试模型是否支持函数调用（使用 `test_multimodal_support.py`）
2. 如果不支持，可以尝试：
   - 使用 `response_format` 参数（如果 LiteLLM 支持）
   - 通过 prompt 要求 JSON 输出
   - 如果项目无法正常工作，可能需要修改代码来适配

## 总结

- **函数调用** = 让模型以结构化方式输出数据，确保符合 Schema
- **MERI 项目使用它** = 确保提取的数据完全符合您定义的 JSON Schema
- **如果不支持** = 可以通过其他方式（response_format 或 prompt）要求 JSON 输出，但可能不如函数调用可靠




